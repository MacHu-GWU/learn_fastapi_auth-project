[env]
PY_PROJECT_NAME = "learn_fastapi_auth"

[tools]
python = "3.12"
ruff = "latest"
uv = "latest"
node = "24"
pnpm = "latest"

[tasks.venv-create]
description = "â­ Create project virtual environment (.venv)"
run = "uv venv"

[tasks.venv-remove]
description = "ðŸ’¥ Remove project virtual environment completely"
run = "rm -r .venv"

[tasks.inst]
description = "â­ Install main runtime dependencies and all extra dependencies (dev, test, doc, ...)"
run = "uv sync --all-extras"

[tasks.export]
description = "â­ Export locked dependencies to requirements.txt for deployment"
run = """
uv export --no-dev --no-hashes > requirements.txt
uv export --no-dev --all-extras --no-hashes > requirements-all.txt
"""

[tasks.fmt]
description = "Format code"
run = "ruff format $PY_PROJECT_NAME/"

[tasks.test]
description = "â­ Run unit tests"
run = """
.venv/bin/pytest \
    -s \
    --rootdir=. \
    tests
"""

[tasks.cov]
description = "â­ Run tests with coverage analysis"
run = """
.venv/bin/pytest \
    -s \
    --tb=native \
    --rootdir=. \
    --cov=$PY_PROJECT_NAME \
    --cov-report term-missing \
    --cov-report html:htmlcov \
    tests
"""

[tasks.view-cov]
description = "â­ Open coverage report in browser (run after cov)"
run = """
open htmlcov/index.html
"""

[tasks.build-doc]
description = "â­ Build Sphinx documentation (output: docs/build/html)"
run = """
.venv/bin/sphinx-build \
    -M \
    html \
    docs/source \
    docs/build
"""

[tasks.view-doc]
description = "â­ Open built documentation in browser"
run = """
open docs/build/html/index.html
"""

[tasks.build]
description = "ðŸ— Build Python wheel and source distribution packages"
run = """
uv build
"""

[tasks.publish]
description = "â­ Build and publish package to AWS CodeArtifact"
run = """
.venv/bin/twine \
    upload \
    dist/*
"""
depends = ['build']

[tasks.run-backend]
description = "Run FastAPI backend server at localhost:8000"
run = """
.venv/bin/python main.py
"""
depends = ['inst']

[tasks.run-frontend]
description = "Run Next.js frontend dev server at localhost:3000"
run = """
pnpm install && pnpm run dev
"""

[tasks.run]
description = "â­ Run both backend (port 8000) and frontend (port 3000) servers"
run = """
# Start backend in background
.venv/bin/python main.py &
BACKEND_PID=$!

# Trap to kill backend when script exits
trap "kill $BACKEND_PID 2>/dev/null" EXIT

# Install frontend dependencies and start frontend in foreground
pnpm install && pnpm run dev
"""
depends = ['inst']

[tasks.kill]
description = "Kill debug server at localhost"
run = """
.venv/bin/python scripts/kill_all_servers.py
"""
depends = ['inst']
