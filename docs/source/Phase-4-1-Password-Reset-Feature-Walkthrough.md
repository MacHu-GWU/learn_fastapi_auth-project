# Phase 4.1 Password Feature Walkthrough

This document explains all code changes made to implement the Password Reset and Change Password features.

---

## 1. Password Reset Email Function

**File**: `learn_fastapi_auth/auth/email.py`

### 1.1 Email HTML Template

```python
def get_password_reset_email_html(reset_url: str) -> str:
    """Generate HTML content for password reset email."""
    return f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {{ font-family: Arial, sans-serif; }}
        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
        .button {{
            display: inline-block;
            padding: 12px 24px;
            background-color: #dc3545;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h2>Reset Your Password</h2>
        <p><a href="{reset_url}" class="button">Reset Password</a></p>
        <p>This link expires in 15 minutes.</p>
    </div>
</body>
</html>"""
```

**Key Points**:
- Use `f-string` for URL interpolation
- Double braces `{{` `}}` escape curly braces in f-strings
- Button styled with CSS for better UX

### 1.2 Send Password Reset Email Function

```python
async def send_password_reset_email(email: str, token: str) -> bool:
    reset_url = f"{config.frontend_url}/auth/reset-password?token={token}"
    return await send_email(
        to_email=email,
        subject="Reset Your Password",
        html_content=get_password_reset_email_html(reset_url),
        text_content=get_password_reset_email_text(reset_url),
    )
```

**Key Points**:
- Constructs URL with token as query parameter
- Reuses existing `send_email()` function
- Returns boolean for success/failure

---

## 2. UserManager Hook Update

**File**: `learn_fastapi_auth/auth/users.py`

```python
async def on_after_forgot_password(
    self,
    user: User,
    token: str,
    request: Optional[Request] = None,
) -> None:
    """Called after a user requests password reset."""
    from learn_fastapi_auth.auth.email import send_password_reset_email
    await send_password_reset_email(user.email, token)
    print(f"User {user.id} has forgot their password. Reset token: {token}")
```

**Key Points**:
- Hook is automatically called by fastapi-users after `POST /api/auth/forgot-password`
- Token is generated by fastapi-users, we just need to send it
- Import inside function to avoid circular imports

---

## 3. Change Password Schema

**File**: `learn_fastapi_auth/schemas.py`

```python
class ChangePasswordRequest(BaseModel):
    """Schema for changing password."""
    current_password: str = Field(..., description="Current password for verification")
    new_password: str = Field(..., min_length=8, description="New password")
```

**Key Points**:
- `Field(...)` means required field
- `min_length=8` validates minimum password length
- Pydantic auto-validates on request

---

## 4. Change Password API Endpoint

**File**: `learn_fastapi_auth/app.py`

```python
@app.post("/api/auth/change-password", response_model=MessageResponse, tags=["auth"])
async def change_password(
    data: ChangePasswordRequest,
    user: User = Depends(current_active_user),
    user_manager=Depends(get_user_manager),
):
    # Verify current password
    verified, _ = user_manager.password_helper.verify_and_update(
        data.current_password, user.hashed_password
    )
    if not verified:
        raise HTTPException(status_code=400, detail="CHANGE_PASSWORD_INVALID_CURRENT")

    # Update to new password
    hashed_password = user_manager.password_helper.hash(data.new_password)
    user.hashed_password = hashed_password

    session = user_manager.user_db.session
    session.add(user)
    await session.commit()

    return MessageResponse(message="Password changed successfully")
```

**Key Points**:
- `Depends(current_active_user)`: Requires authentication
- `password_helper.verify_and_update()`: Verifies password against hash
- `password_helper.hash()`: Hashes new password
- Manual session commit to persist changes

---

## 5. Password Reset Redirect Route

**File**: `learn_fastapi_auth/app.py`

```python
@app.get("/auth/reset-password", tags=["pages"])
async def reset_password_redirect(
    token: str = Query(..., description="Password reset token"),
):
    return RedirectResponse(
        url=f"{config.frontend_url}/reset-password?token={token}",
        status_code=status.HTTP_302_FOUND,
    )
```

**Key Points**:
- Handles email link click
- Redirects to frontend page with token
- HTTP 302 (Found) for redirect

---

## 6. Page Routes

**File**: `learn_fastapi_auth/routers/pages.py`

```python
@router.get("/forgot-password", response_class=HTMLResponse)
async def forgot_password(request: Request):
    return templates.TemplateResponse(request, "forgot_password.html")

@router.get("/reset-password", response_class=HTMLResponse)
async def reset_password(request: Request):
    return templates.TemplateResponse(request, "reset_password.html")
```

**Key Points**:
- Simple routes that render templates
- `response_class=HTMLResponse` for proper content type

---

## 7. Forgot Password Template

**File**: `learn_fastapi_auth/templates/forgot_password.html`

Key JavaScript:

```javascript
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();

    const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    });

    // Show same message regardless of email existence (security)
    showToast('If an account exists, you will receive a reset link.', 'success');
});
```

**Key Points**:
- Always shows same message for security (doesn't reveal if email exists)
- Uses fetch API to call backend

---

## 8. Reset Password Template

**File**: `learn_fastapi_auth/templates/reset_password.html`

Key JavaScript:

```javascript
// Get token from URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
    showToast('Invalid reset token', 'error');
    window.location.href = '/forgot-password';
    return;
}

// Submit handler
const response = await fetch('/api/auth/reset-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token, password })
});
```

**Key Points**:
- Extracts token from URL query string
- Validates token exists before showing form
- Sends token + new password to API

---

## 9. Change Password Modal

**File**: `learn_fastapi_auth/templates/app.html`

```html
<!-- Change Password Modal -->
<div class="modal-overlay" id="password-modal-overlay">
    <div class="modal">
        <h2>Change Password</h2>
        <form id="change-password-form">
            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" required>
                <div class="error-message" id="current-password-error"></div>
            </div>
            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" required>
                <div class="error-message" id="new-password-error"></div>
            </div>
            <!-- ... confirm password field ... -->
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" id="password-cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary" id="password-save-btn">Change Password</button>
            </div>
        </form>
    </div>
</div>
```

**Key Points**:
- Modal overlay for dimmed background
- Form with validation error messages
- Cancel button is `type="button"` to prevent form submit

---

## 10. Change Password JavaScript

**File**: `learn_fastapi_auth/static/js/app.js`

```javascript
async function handleChangePassword(e) {
    e.preventDefault();
    clearPasswordErrors();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmNewPassword = document.getElementById('confirm-new-password').value;

    // Validation
    if (!validatePassword(newPassword)) {
        showPasswordFieldError('new-password', 'Password must be 8+ chars with letters and numbers');
        return;
    }
    if (newPassword !== confirmNewPassword) {
        showPasswordFieldError('confirm-new-password', 'Passwords do not match');
        return;
    }

    // API call
    const response = await apiRequest('/api/auth/change-password', {
        method: 'POST',
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    });

    if (response.ok) {
        closePasswordModal();
        showToast('Password changed successfully!', 'success');
    } else {
        const error = await response.json();
        if (error.detail === 'CHANGE_PASSWORD_INVALID_CURRENT') {
            showPasswordFieldError('current-password', 'Current password is incorrect');
        }
    }
}
```

**Key Points**:
- `e.preventDefault()` stops form from submitting normally
- Client-side validation before API call
- Uses `apiRequest()` helper which adds auth token
- Specific error handling for invalid current password

---

## 11. Unit Tests

**File**: `tests/test_app.py`

### Password Reset Tests

```python
class TestPasswordReset:
    async def test_forgot_password_existing_email(self, ...):
        # Register user, request reset, verify 202 response
        
    async def test_forgot_password_nonexistent_email(self, ...):
        # Request reset for non-existent email, still returns 202 (security)
        
    async def test_reset_password_invalid_token(self, ...):
        # Try reset with bad token, verify 400 + RESET_PASSWORD_BAD_TOKEN
```

### Change Password Tests

```python
class TestChangePassword:
    async def test_change_password_success(self, ...):
        # Change password, verify old doesn't work, new works
        
    async def test_change_password_wrong_current(self, ...):
        # Try with wrong current password, verify error
        
    async def test_change_password_unauthorized(self, ...):
        # Try without auth token, verify 401
```

---

## Flow Diagrams

### Password Reset Flow

```
User forgets password
        |
        v
GET /forgot-password (page)
        |
        v
Enter email, submit
        |
        v
POST /api/auth/forgot-password
        |
        v
fastapi-users generates token
        |
        v
on_after_forgot_password() hook
        |
        v
send_password_reset_email()
        |
        v
Email sent with link: /auth/reset-password?token=xxx
        |
        v
User clicks link
        |
        v
GET /auth/reset-password?token=xxx (redirect)
        |
        v
Redirect to /reset-password?token=xxx (frontend)
        |
        v
User enters new password
        |
        v
POST /api/auth/reset-password
        |
        v
Password updated, redirect to signin
```

### Change Password Flow

```
Logged-in user on /app
        |
        v
Click "Change Password" button
        |
        v
Modal opens
        |
        v
Enter current + new password
        |
        v
POST /api/auth/change-password
        |
        v
Verify current password (password_helper)
        |
        v
Hash and save new password
        |
        v
Success toast, modal closes
```

---

**End of Walkthrough**
