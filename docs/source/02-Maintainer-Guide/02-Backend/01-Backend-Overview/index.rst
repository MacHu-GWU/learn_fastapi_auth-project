Backend Overview
==============================================================================

概述
------------------------------------------------------------------------------
后端基于 **FastAPI** 构建，配合关系型数据库和 AWS 云服务。整体架构遵循分层设计，职责清晰。


整体架构
------------------------------------------------------------------------------
请求从外到内经过以下层次：

1. **Vercel Serverless** - 云端运行环境

   - ``api/`` 目录作为入口，接收 HTTP 请求

2. **FastAPI 应用** (``learn_fastapi_auth/``)

   - ``core/`` - 应用初始化、中间件、生命周期
   - ``routers/`` - 路由定义，分发请求到对应处理函数
   - ``auth/`` - 认证相关业务逻辑
   - ``config/`` - 配置管理

3. **单例资源层** (``one/``)

   - 管理全局共享资源：数据库连接、配置实例、AWS 客户端

4. **外部服务**

   - 数据库 (PostgreSQL / SQLite)
   - AWS 服务


目录结构
------------------------------------------------------------------------------

根目录
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 路径
     - 职责
   * - ``api/``
     - Vercel Serverless 入口点，将请求转发给 FastAPI 应用
   * - ``learn_fastapi_auth/``
     - Python 主包，包含所有后端业务逻辑
   * - ``tests/``
     - pytest 单元测试和集成测试
   * - ``config/``
     - 配置数据文件 (JSON 格式)，由配置管理系统读取
   * - ``pyproject.toml``
     - Python 项目元数据、依赖声明、工具配置


主包 ``learn_fastapi_auth/``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
按职责分为以下子模块：

**应用核心层**

.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 模块
     - 职责
   * - ``core/``
     - 应用工厂、生命周期管理、中间件配置
   * - ``routers/``
     - HTTP 路由定义，按功能分组 (认证、用户数据、页面等)
   * - ``app.py``
     - FastAPI 应用实例
   * - ``create_app.py``
     - 应用创建入口

**数据层**

.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 模块
     - 职责
   * - ``models.py``
     - SQLAlchemy ORM 模型定义
   * - ``schemas.py``
     - Pydantic 请求/响应 Schema
   * - ``database.py``
     - 数据库连接和会话管理

**业务逻辑层**

.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 模块
     - 职责
   * - ``auth/``
     - 用户认证、邮件发送、OAuth 集成
   * - ``config/``
     - 配置类定义和加载逻辑
   * - ``one/``
     - 单例资源管理 (数据库连接、配置实例、AWS 客户端等)

**基础设施层**

.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 模块
     - 职责
   * - ``runtime.py``
     - 运行时检测 (本地/Lambda/Vercel)
   * - ``env.py``
     - 部署环境管理 (dev, tst, prd)
   * - ``boto_ses.py``
     - AWS Boto Session 管理
   * - ``paths.py``
     - 路径常量管理
   * - ``logger.py``
     - 日志配置
   * - ``ratelimit.py``
     - API 频率限制
   * - ``csrf.py``
     - CSRF 防护


路由模块 ``routers/``
------------------------------------------------------------------------------
路由模块定义所有 HTTP 端点，按功能职责划分为多个文件：

.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - 模块
     - 职责
   * - ``health.py``
     - 健康检查端点，用于监控和部署验证
   * - ``auth_routes.py``
     - 用户认证相关：注册、登录、登出、密码重置、邮箱验证、OAuth 回调
   * - ``pages.py``
     - 服务端渲染页面 (如有)。随着页面增多，可能拆分为 ``pages/`` 子目录
   * - ``user_data_routes.py``
     - SaaS 业务逻辑端点。随着业务复杂化，可能拆分为 ``user_data/`` 子目录


设计模式
------------------------------------------------------------------------------

单例模式 (``one/`` 目录)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
``one/`` 目录实现了资源单例管理。数据库连接、配置对象、AWS 客户端等昂贵资源只初始化一次，全局复用。这避免了重复创建连接的开销，也确保了状态一致性。

应用工厂模式 (``core/app_factory.py``)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
FastAPI 应用通过工厂函数创建，而非直接实例化。这使得：

- 测试时可以创建隔离的应用实例
- 不同环境可以使用不同配置
- 中间件和路由可以按需组装

分层架构
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
代码按职责分层：

1. **路由层** - 处理 HTTP 请求，调用业务逻辑
2. **业务层** - 实现具体功能 (认证、数据处理)
3. **数据层** - ORM 模型和数据库操作
4. **基础设施层** - 日志、配置、环境等通用功能

各层之间单向依赖，上层调用下层，下层不依赖上层。
