# Phase 4.1 Password Feature Walkthrough

This document explains all code changes made to implement the Password Reset and Change Password features.

---

## 1. Token Expiration Configuration

**File**: `learn_fastapi_auth/config.py`

```python
@dataclasses.dataclass
class Config:
    # ... other fields ...
    verification_token_lifetime: int = dataclasses.field()
    reset_password_token_lifetime: int = dataclasses.field()  # NEW
    access_token_lifetime: int = dataclasses.field()

    @classmethod
    def from_env(cls) -> "Config":
        return cls(
            # ...
            reset_password_token_lifetime=int(
                os.environ.get("RESET_PASSWORD_TOKEN_LIFETIME", "900")  # 15 min default
            ),
            # ...
        )
```

**Key Points**:
- Default is 900 seconds (15 minutes)
- Configurable via environment variable `RESET_PASSWORD_TOKEN_LIFETIME`

---

## 2. UserManager Token Lifetime Settings

**File**: `learn_fastapi_auth/auth/users.py`

```python
class UserManager(UUIDIDMixin, BaseUserManager[User, uuid.UUID]):
    reset_password_token_secret = config.secret_key
    reset_password_token_lifetime_seconds = config.reset_password_token_lifetime  # NEW
    verification_token_secret = config.secret_key
    verification_token_lifetime_seconds = config.verification_token_lifetime  # NEW
```

**Key Points**:
- `reset_password_token_lifetime_seconds` controls how long reset tokens are valid
- `verification_token_lifetime_seconds` controls email verification token lifetime
- Both are read from config, making them environment-configurable

**How fastapi-users uses these values**:
1. When generating reset token: Creates JWT with `exp` claim = current_time + lifetime_seconds
2. When validating reset token: Checks if `exp` > current_time
3. If expired: Returns `RESET_PASSWORD_BAD_TOKEN` error

---

## 3. Password Reset Email Function

**File**: `learn_fastapi_auth/auth/email.py`

### 3.1 Email HTML Template

```python
def get_password_reset_email_html(reset_url: str) -> str:
    return f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {{ font-family: Arial, sans-serif; }}
        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
        .button {{
            display: inline-block;
            padding: 12px 24px;
            background-color: #dc3545;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h2>Reset Your Password</h2>
        <p><a href="{reset_url}" class="button">Reset Password</a></p>
        <p>This link expires in 15 minutes.</p>
    </div>
</body>
</html>"""
```

**Key Points**:
- Use `f-string` for URL interpolation
- Double braces `{{` `}}` escape curly braces in f-strings
- Button styled with CSS for better UX

### 3.2 Send Password Reset Email Function

```python
async def send_password_reset_email(email: str, token: str) -> bool:
    reset_url = f"{config.frontend_url}/auth/reset-password?token={token}"
    return await send_email(
        to_email=email,
        subject="Reset Your Password",
        html_content=get_password_reset_email_html(reset_url),
        text_content=get_password_reset_email_text(reset_url),
    )
```

**Key Points**:
- Constructs URL with token as query parameter
- Reuses existing `send_email()` function
- Returns boolean for success/failure

---

## 4. UserManager Hook Update

**File**: `learn_fastapi_auth/auth/users.py`

```python
async def on_after_forgot_password(
    self,
    user: User,
    token: str,
    request: Optional[Request] = None,
) -> None:
    """Called after a user requests password reset."""
    from learn_fastapi_auth.auth.email import send_password_reset_email
    await send_password_reset_email(user.email, token)
    print(f"User {user.id} has forgot their password. Reset token: {token}")
```

**Key Points**:
- Hook is automatically called by fastapi-users after `POST /api/auth/forgot-password`
- Token is generated by fastapi-users (includes expiration), we just send it
- Import inside function to avoid circular imports

---

## 5. Change Password Schema

**File**: `learn_fastapi_auth/schemas.py`

```python
class ChangePasswordRequest(BaseModel):
    """Schema for changing password."""
    current_password: str = Field(..., description="Current password for verification")
    new_password: str = Field(..., min_length=8, description="New password")
```

**Key Points**:
- `Field(...)` means required field
- `min_length=8` validates minimum password length
- Pydantic auto-validates on request

---

## 6. Change Password API Endpoint

**File**: `learn_fastapi_auth/app.py`

```python
@app.post("/api/auth/change-password", response_model=MessageResponse, tags=["auth"])
async def change_password(
    data: ChangePasswordRequest,
    user: User = Depends(current_active_user),
    user_manager=Depends(get_user_manager),
):
    # Verify current password
    verified, _ = user_manager.password_helper.verify_and_update(
        data.current_password, user.hashed_password
    )
    if not verified:
        raise HTTPException(status_code=400, detail="CHANGE_PASSWORD_INVALID_CURRENT")

    # Update to new password
    hashed_password = user_manager.password_helper.hash(data.new_password)
    user.hashed_password = hashed_password

    session = user_manager.user_db.session
    session.add(user)
    await session.commit()

    return MessageResponse(message="Password changed successfully")
```

**Key Points**:
- `Depends(current_active_user)`: Requires authentication
- `password_helper.verify_and_update()`: Verifies password against hash
- `password_helper.hash()`: Hashes new password
- Manual session commit to persist changes

---

## 7. Password Reset Redirect Route

**File**: `learn_fastapi_auth/app.py`

```python
@app.get("/auth/reset-password", tags=["pages"])
async def reset_password_redirect(
    token: str = Query(..., description="Password reset token"),
):
    return RedirectResponse(
        url=f"{config.frontend_url}/reset-password?token={token}",
        status_code=status.HTTP_302_FOUND,
    )
```

**Key Points**:
- Handles email link click
- Redirects to frontend page with token
- HTTP 302 (Found) for redirect

---

## 8. Page Routes

**File**: `learn_fastapi_auth/routers/pages.py`

```python
@router.get("/forgot-password", response_class=HTMLResponse)
async def forgot_password(request: Request):
    return templates.TemplateResponse(request, "forgot_password.html")

@router.get("/reset-password", response_class=HTMLResponse)
async def reset_password(request: Request):
    return templates.TemplateResponse(request, "reset_password.html")
```

**Key Points**:
- Simple routes that render templates
- `response_class=HTMLResponse` for proper content type

---

## 9. Forgot Password Template

**File**: `learn_fastapi_auth/templates/forgot_password.html`

Key JavaScript:

```javascript
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();

    const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    });

    // Show same message regardless of email existence (security)
    showToast('If an account exists, you will receive a reset link.', 'success');
});
```

**Key Points**:
- Always shows same message for security (doesn't reveal if email exists)
- Uses fetch API to call backend

---

## 10. Reset Password Template

**File**: `learn_fastapi_auth/templates/reset_password.html`

Key JavaScript:

```javascript
// Get token from URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
    showToast('Invalid reset token', 'error');
    window.location.href = '/forgot-password';
    return;
}

// Submit handler
const response = await fetch('/api/auth/reset-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token, password })
});

// Handle expiration error
if (data.detail === 'RESET_PASSWORD_BAD_TOKEN') {
    showToast('Reset link has expired or is invalid.', 'error');
}
```

**Key Points**:
- Extracts token from URL query string
- Validates token exists before showing form
- Sends token + new password to API
- Handles `RESET_PASSWORD_BAD_TOKEN` error (includes expiration)

---

## 11. Change Password Modal

**File**: `learn_fastapi_auth/templates/app.html`

```html
<!-- Change Password Modal -->
<div class="modal-overlay" id="password-modal-overlay">
    <div class="modal">
        <h2>Change Password</h2>
        <form id="change-password-form">
            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" required>
            </div>
            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" required>
            </div>
            <!-- ... confirm password field ... -->
        </form>
    </div>
</div>
```

---

## 12. Change Password JavaScript

**File**: `learn_fastapi_auth/static/js/app.js`

```javascript
async function handleChangePassword(e) {
    e.preventDefault();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;

    const response = await apiRequest('/api/auth/change-password', {
        method: 'POST',
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    });

    if (response.ok) {
        showToast('Password changed successfully!', 'success');
    } else {
        const error = await response.json();
        if (error.detail === 'CHANGE_PASSWORD_INVALID_CURRENT') {
            showPasswordFieldError('current-password', 'Current password is incorrect');
        }
    }
}
```

---

## 13. Unit Tests

**File**: `tests/test_app.py`

### Password Reset Tests

```python
class TestPasswordReset:
    async def test_forgot_password_existing_email(self, ...):
        # Register user, request reset, verify 202 response
        
    async def test_forgot_password_nonexistent_email(self, ...):
        # Request reset for non-existent email, still returns 202 (security)
        
    async def test_reset_password_invalid_token(self, ...):
        # Try reset with bad token, verify 400 + RESET_PASSWORD_BAD_TOKEN
        # This also covers expired tokens since they return the same error
```

### Change Password Tests

```python
class TestChangePassword:
    async def test_change_password_success(self, ...):
        # Change password, verify old doesn't work, new works
        
    async def test_change_password_wrong_current(self, ...):
        # Try with wrong current password, verify error
        
    async def test_change_password_unauthorized(self, ...):
        # Try without auth token, verify 401
```

---

## Flow Diagrams

### Password Reset Flow with Expiration

```
User forgets password
        |
        v
GET /forgot-password (page)
        |
        v
Enter email, submit
        |
        v
POST /api/auth/forgot-password
        |
        v
fastapi-users generates JWT token with:
  - user_id in payload
  - exp = current_time + reset_password_token_lifetime_seconds
        |
        v
on_after_forgot_password() hook
        |
        v
send_password_reset_email()
        |
        v
Email sent with link: /auth/reset-password?token=xxx
        |
        v
User clicks link (within 15 min)
        |
        v
GET /auth/reset-password?token=xxx (redirect)
        |
        v
Redirect to /reset-password?token=xxx (frontend)
        |
        v
User enters new password
        |
        v
POST /api/auth/reset-password
        |
        v
fastapi-users validates token:
  - Verify signature with reset_password_token_secret
  - Check exp > current_time
        |
   +---------+---------+
   |                   |
   v                   v
Valid              Expired/Invalid
   |                   |
   v                   v
Password updated    RESET_PASSWORD_BAD_TOKEN
   |
   v
Redirect to signin
```

### Change Password Flow

```
Logged-in user on /app
        |
        v
Click "Change Password" button
        |
        v
Modal opens
        |
        v
Enter current + new password
        |
        v
POST /api/auth/change-password
        |
        v
Verify current password (password_helper)
        |
        v
Hash and save new password
        |
        v
Success toast, modal closes
```

---

**End of Walkthrough**
